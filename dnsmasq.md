# dnsmasq as local DNS server
## Set up dnsmasq as the default local DNS server
First, install `dnsmasq`
```bash
$ sudo apt install dnsmasq
```
Disable `systemd-resolved` which is the default dns server stub
```bash
$ sudo systemctl stop systemd-resolved
$ sudo systemctl disable systemd-resolved
```
Or if we want to keep `systemd-resolved` running but not binding to port `53`, adding a file at `/etc/systemd/resolved.conf.d` with the content
```bash
$ sudo mkdir -p /etc/systemd/resolved.conf.d
$ cat << EOF | sudo tee /etc/systemd/resolved.conf.d/noresolved.conf
[Resolve]
DNSStubListener=no
EOF
$ sudo systemctl restart systemd-resolved
```
We also need to disable overriding of `/etc/resolv.conf` by `NetworkManager` (and also avoid `NetworkManager` from spinning its own dnsmasq server- not confirmed but observed locally)
```bash
$ cat << EOF | sudo tee /etc/NetworkManager/conf.d/disableresolv.conf
[main]
dns=none
EOF
$ sudo systemctl restart NetworkManager
```
Start and enable `dnsmasq`
```bash
$ sudo systemctl enable dnsmasq
$ sudo systemctl start dnsmasq
```
## Set up /etc/resolv.conf for DNS lookup
To dynamically update `/etc/resolv.conf` (dns resolver), install `resolvconf` to dynamically compute the resolver list from info collected from `/etc/resolvconf/resolv.conf.d/{head,base,tail}` and from the system.
```bash
$ sudo apt install resolvconf
```
Update the `/etc/resolvconf/resolv.conf.d/tail` file with additional resolvers, since `resolvconf` can see that `dnsmasq` is running on `127.0.0.1:53` and add that automatically to dns resolver list. The resolvers from the `tail` file will be appended after the local resolver(`127.0.0.1`).
```bash
$ cat << EOF | sudo tee /etc/resolvconf/resolv.conf.d/tail
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF
```
Link `/etc/resolv.conf` to `/run/resolvconf/resolv.conf` which is the the computed `resolv.conf` by the `resolvconf` service
```bash
$ sudo ln -s /run/resolvconf/resolv.conf /etc/resolv.conf
```
Update `resolvconf` with the new data
```bash
$ sudo resolvconf -u
$ cat /etc/resolv.conf 
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
# 127.0.0.53 is the systemd-resolved stub resolver.
# run "systemd-resolve --status" to see details about the actual nameservers.
nameserver 127.0.0.1
nameserver 8.8.8.8
nameserver 8.8.4.4
```
Enable and start `resolvconf` so it can watch changes to the system's dns services
```bash
$ sudo systemctl enable resolvconf
$ sudo systemctl start resolvconf
```
## Set up wildcard domains
If we want to add a whole subdmain dns resolution (wildcard domain), create a new config file in `/etc/dnsmasq.d/` or update `/etc/dnsmasq.conf`
```bash
$ cat << EOF | sudo tee /etc/dnsmasq.d/crc.conf
address=/apps-crc.testing/192.168.122.44
address=/crc.testing/192.168.122.44
EOF
```
The `crc.conf` created above will resolve all domains ending with `apps-crc.testing` and `crc.testing` with the IP `192.168.122.44`. Restart `dnsmasq` and test the dns resolution
```bash
$ sudo systemctl restart dnsmasq
$ dig +noall +answer crc.testing
crc.testing.            0       IN      A       192.168.122.44
$ dig +noall +answer api.crc.testing
api.crc.testing.        0       IN      A       192.168.122.44
$ dig +noall +answer apps-crc.testing
apps-crc.testing.       0       IN      A       192.168.122.44
$ dig +noall +answer console.apps-crc.testing
console.apps-crc.testing. 0     IN      A       192.168.122.44
```

# ToDo: dnsmasq as DHCP server
## References
- [How to avoid conflicts between dnsmasq and systemd-resolved?](https://unix.stackexchange.com/questions/304050/how-to-avoid-conflicts-between-dnsmasq-and-systemd-resolved)
- [How to disable systemd-resolved and resolve DNS with dnsmasq?](https://askubuntu.com/questions/898605/how-to-disable-systemd-resolved-and-resolve-dns-with-dnsmasq)
- [How do I set my DNS when resolv.conf is being overwritten?](https://unix.stackexchange.com/questions/128220/how-do-i-set-my-dns-when-resolv-conf-is-being-overwritten)
- [Configure DNS Wildcard with Dnsmasq Service](https://qiita.com/bmj0114/items/9c24d863bcab1a634503)
- [Wildcard subdomains with dnsmasq](https://stackoverflow.com/questions/22313142/wildcard-subdomains-with-dnsmasq)